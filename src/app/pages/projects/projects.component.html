<div class="card">
    <h2 style="margin-bottom: 15px;">Project management</h2>
    <app-table-filter (toggleSideTab)="toggleSideTab()" (selectionChange)="onViewSelected($event)"
        [viewOptions]="viewOptions"></app-table-filter>
    <div
        style="margin-bottom: 15px; margin-top: 10px; font-size: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
        <div class="theme-grid">
            <div class="tabulator-table"></div>
        </div>
    </div>
</div>

<!-- Filter Side Drawer & Backdrop -->
<div class="filter-backdrop" *ngIf="isFilterOpen" (click)="toggleSideTab()"></div>

<div class="filter-drawer" [class.open]="isFilterOpen">
    <div class="drawer-header">
        <button class="icon-btn close-btn" (click)="toggleSideTab()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>

    <div class="drawer-content">
        <!-- Main Scrollable Content -->
        <div class="page-container">

            <!-- Header -->
            <header class="form-header">
                <div class="header-content">
                    <h1>{{ isEditMode ? 'Update Project' : 'Create New Project' }}</h1>
                    <p>{{ isEditMode ? 'Modify project details and assignments' :
                        'Define scope, timeline, and team for a new project' }}</p>
                </div>
            </header>

            <form [formGroup]="projectForm" class="main-form">

                <!-- SECTION 1: Project Essentials -->
                <section class="form-section">
                    <h2 class="section-title">Project Details</h2>

                    <div class="fields-grid">
                        <!-- Title -->
                        <div class="form-group full-width-desktop">
                            <label>Project Title <span class="required">*</span></label>
                            <input type="text" formControlName="project_title"
                                placeholder="e.g. R-SPACE3 Employee Management">
                            <div class="error-msg"
                                *ngIf="rf.project_title?.invalid && (rf.project_title?.dirty || rf.project_title?.touched)">
                                Title is required.
                            </div>
                        </div>

                        <!-- Client -->
                        <div class="form-group">
                            <label>Client Name <span class="required">*</span></label>
                            <input type="text" formControlName="client" placeholder="e.g. Ridsys">
                            <div class="error-msg"
                                *ngIf="rf.client?.invalid && (rf.client?.dirty || rf.client?.touched)">
                                Client is required.
                            </div>
                        </div>

                        <!-- Start Date -->
                        <div class="form-group">
                            <label>Start Date <span class="required">*</span></label>
                            <input type="date" formControlName="start_date">
                            <div class="error-msg"
                                *ngIf="rf.start_date?.invalid && (rf.start_date?.dirty || rf.start_date?.touched)">
                                Start Date is required.
                            </div>
                        </div>

                        <!-- End Date -->
                        <div class="form-group">
                            <label>End Date <span class="required">*</span></label>
                            <input type="date" formControlName="end_date">
                            <div class="error-msg"
                                *ngIf="rf.end_date?.invalid && (rf.end_date?.dirty || rf.end_date?.touched)">
                                End Date is required.
                            </div>
                        </div>

                        <!-- Manager -->
                        <div class="form-group">
                            <label>Assigned Manager <span class="required">*</span></label>
                            <div class="select-wrapper">
                                <select formControlName="assigned_manager">
                                    <option [ngValue]="null" disabled>Select Manager</option>
                                    <option *ngFor="let m of departmentList" [value]="m.id">{{ m.department_name }}
                                    </option>
                                </select>
                                <svg class="select-arrow" viewBox="0 0 24 24">
                                    <path d="M7 10l5 5 5-5z" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="error-msg"
                                *ngIf="rf.assigned_manager?.invalid && (rf.assigned_manager?.dirty || rf.assigned_manager?.touched)">
                                Manager is required.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Toggle Row -->
                <div class="toggles-row">
                    <div class="toggle-group">
                        <label class="switch">
                            <input type="checkbox" formControlName="ispublic">
                            <span class="slider round"></span>
                        </label>
                        <div class="toggle-label">
                            <span>Public Project</span>
                            <small>Visible to all employees in the organization</small>
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <!-- SECTION 2: Assignments -->
                <section class="form-section" [class.section-disabled]="isPublic">
                    <h2 class="section-title">Resource Assignment</h2>
                    <div class="fields-grid three-col">

                        <!-- Department -->
                        <div class="form-group">
                            <label>Department <span class="required" *ngIf="!isPublic">*</span></label>
                            <div class="select-wrapper">
                                <select formControlName="deptid">
                                    <option [ngValue]="null" disabled>Select Department</option>
                                    <option *ngFor="let d of departmentList" [value]="d.id">{{ d.department_name }}
                                    </option>
                                </select>
                                <svg class="select-arrow" viewBox="0 0 24 24">
                                    <path d="M7 10l5 5 5-5z" fill="currentColor" />
                                </svg>
                            </div>
                            <div class="error-msg"
                                *ngIf="rf.deptid?.invalid && (rf.deptid?.dirty || rf.deptid?.touched)">
                                Department is required.
                            </div>
                        </div>

                        <!-- Team Members (Custom Multi Select) -->
                        <div class="form-group full-width-mobile">
                            <label>Team Members <span class="required" *ngIf="!isPublic">*</span></label>

                            <!-- Backdrop -->
                            <div class="dropdown-backdrop" *ngIf="isTeamDropdownOpen"
                                (click)="isTeamDropdownOpen = false"></div>

                            <div class="multi-select-container" [class.open]="isTeamDropdownOpen"
                                [class.disabled-input]="isPublic">

                                <!-- Trigger Box -->
                                <div class="multi-select-trigger"
                                    (click)="!isPublic && (isTeamDropdownOpen = !isTeamDropdownOpen)"
                                    [class.has-error]="rf.employee_list?.invalid && (rf.employee_list?.dirty || rf.employee_list?.touched)">

                                    <!-- Selected Chips -->
                                    <div class="chips-container"
                                        *ngIf="selectedEmployeeIds.length > 0; else placeholder">
                                        <span class="chip" *ngFor="let id of selectedEmployeeIds"
                                            (click)="$event.stopPropagation()">
                                            <span class="chip-avatar">{{ getInitials(getEmployeeName(id)) }}</span>
                                            {{ getEmployeeName(id) }}
                                            <span class="chip-remove" (click)="!isPublic && toggleEmployee(id)">Ã—</span>
                                        </span>
                                    </div>

                                    <!-- Placeholder -->
                                    <ng-template #placeholder>
                                        <span class="placeholder-text">{{ isPublic ? 'Not applicable' :
                                            'Select members...' }}</span>
                                    </ng-template>

                                    <!-- Chevron -->
                                    <div class="trigger-actions">
                                        <span class="count-badge" *ngIf="selectedEmployeeIds.length > 0">{{
                                            selectedEmployeeIds.length }}</span>
                                        <svg class="select-arrow" viewBox="0 0 24 24">
                                            <path d="M7 10l5 5 5-5z" fill="currentColor" />
                                        </svg>
                                    </div>
                                </div>

                                <!-- Dropdown Panel -->
                                <div class="multi-select-dropdown" *ngIf="isTeamDropdownOpen">
                                    <!-- Search Header -->
                                    <div class="dropdown-search">
                                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        </svg>
                                        <input type="text" placeholder="Search people..." [(ngModel)]="teamSearch"
                                            [ngModelOptions]="{standalone: true}" (click)="$event.stopPropagation()">
                                    </div>

                                    <!-- Options List -->
                                    <div class="options-list">
                                        <div class="option-item" *ngFor="let emp of filteredEmployees"
                                            (click)="toggleEmployee(emp.id)"
                                            [class.selected]="isEmployeeSelected(emp.id)">

                                            <div class="option-avatar"
                                                [style.background-color]="getAvatarColor(emp.id)">
                                                {{ getInitials(emp.employee_name) }}
                                            </div>
                                            <div class="option-info">
                                                <span class="option-name">{{ emp.employee_name }}</span>
                                                <span class="option-role">{{ emp.role }}</span>
                                            </div>

                                            <div class="checkbox-custom">
                                                <svg *ngIf="isEmployeeSelected(emp.id)" viewBox="0 0 24 24" fill="none"
                                                    stroke="currentColor" stroke-width="4">
                                                    <polyline points="20 6 9 17 4 12"></polyline>
                                                </svg>
                                            </div>
                                        </div>

                                        <div class="no-results" *ngIf="filteredEmployees.length === 0">
                                            No members found.
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="error-msg"
                                *ngIf="rf.employee_list?.invalid && (rf.employee_list?.dirty || rf.employee_list?.touched)">
                                Team Members are required.
                            </div>
                        </div>

                    </div>
                </section>

                <hr class="divider">

                <!-- SECTION 3: Settings -->
                <section class="form-section">
                    <h2 class="section-title">Additional Details</h2>
                    <div class="fields-grid">
                        <div class="form-group full-width-desktop">
                            <label>Description</label>
                            <textarea formControlName="description" rows="4"
                                placeholder="Describe the project goals..."></textarea>
                        </div>
                    </div>

                    <br>
                    <!-- Creator Email -->
                    <div class="form-group">
                        <label>Created By (Username)</label>
                        <input type="email" formControlName="username" readonly class="readonly-input">
                    </div>
                </section>

            </form>
        </div>

        <!-- Sticky Footer -->
        <div class="drawer-footer">
            <div class="header-actions">
                <button type="button" class="btn btn-secondary" (click)="onCancel()">Cancel</button>
                <button type="button" class="btn btn-primary" (click)="onSubmit()">Save Project</button>
            </div>
        </div>
    </div>


</div>